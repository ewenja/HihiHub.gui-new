-- GrenadeESP.lua
local Camera = workspace.CurrentCamera
local Effects = workspace:WaitForChild("NoCollision"):WaitForChild("Effects")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local GrenadeESP = {}
local Toggles = nil

-- 手雷圖示來源
local ItemList = ReplicatedStorage:WaitForChild("ItemsList")
local ItemIconMap = {}
for _, item in ipairs(ItemList:GetChildren()) do
	local props = item:FindFirstChild("ItemProperties")
	local icon = props and props:FindFirstChild("ItemIcon")
	if icon and icon:IsA("ImageLabel") then
		ItemIconMap[item.Name] = icon.Image
	end
end

-- 引信時間設定
local FuseTimes = {
	F1 = 3,
	RGD5 = 3,
	M84 = 1.2,
	RGO = 5,
	PG4 = 5,
	RGN = 5
}

-- 建立 BillboardGui UI
local function createGrenadeUI(name)
	local gui = Instance.new("BillboardGui")
	gui.Name = "GrenadeESP"
	gui.Size = UDim2.new(0, 60, 0, 80)
	gui.StudsOffset = Vector3.new(0, 2, 0)
	gui.AlwaysOnTop = true

	local icon = Instance.new("ImageLabel", gui)
	icon.Size = UDim2.new(1, 0, 0.8, 0)
	icon.Position = UDim2.new(0, 0, 0, 0)
	icon.BackgroundTransparency = 1
	icon.Image = ItemIconMap[name] or "rbxassetid://0"

	local label = Instance.new("TextLabel", gui)
	label.Size = UDim2.new(1, 0, 0.2, 0)
	label.Position = UDim2.new(0, 0, 0.8, 0)
	label.BackgroundTransparency = 1
	label.TextColor3 = Color3.new(1, 1, 1)
	label.TextStrokeTransparency = 0
	label.TextScaled = true
	label.Font = Enum.Font.GothamBold
	label.Text = name .. " [??s]"

	return gui, label
end

-- 追蹤手雷
local function trackGrenade(grenade, fuseTime, isImpact)
	local root = grenade:FindFirstChildWhichIsA("BasePart") or grenade.PrimaryPart
	if not root then return end

	local gui, label = createGrenadeUI(grenade.Name)
	gui.Adornee = root
	gui.Parent = CoreGui

	local startTime = tick()
	local expired = false

	local conn
	conn = RunService.RenderStepped:Connect(function()
		if not grenade or not grenade.Parent or not root then
			gui:Destroy()
			conn:Disconnect()
			return
		end

		local elapsed = tick() - startTime
		if not expired and not isImpact and elapsed >= fuseTime then
			expired = true
		end

		if isImpact then
			label.Text = grenade.Name .. " [IMPACT]"
		elseif not expired then
			local remaining = math.max(0, math.floor((fuseTime - elapsed) * 10) / 10)
			label.Text = grenade.Name .. " [" .. tostring(remaining) .. "s]"
		else
			label.Text = grenade.Name .. " [BOOM]"
		end
	end)
end

-- 初始化
function GrenadeESP:Init(externalToggles)
	Toggles = externalToggles

	-- 確保只連接一次
	if self._connected then return end
	self._connected = true

	Effects.ChildAdded:Connect(function(grenade)
		task.defer(function()
			if Toggles and Toggles.GrenadeESPEnabled and not Toggles.GrenadeESPEnabled.Value then return end

			local name = grenade.Name
			local fuse = FuseTimes[name]
			if fuse then
				local isImpact = (name == "RGO" or name == "PG4" or name == "RGN")
				trackGrenade(grenade, fuse, isImpact)
			end
		end)
	end)
end

return GrenadeESP
